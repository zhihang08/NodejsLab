function loadFile(e,n,t){var i=new Deferred,a=new Image;return a.onload=function(){n[t]=a,i.resolve(),imageloadprogress++},a.src=e,i.promise()}function callAllPreloads(e,n){for(var t=0;t<e.length;t++)loaders.push(loadFile(n+e[t],e,t))}function NewPiece(e,n,t,i,a,c,s,o,l,r){this.x=e,this.y=n,this.w=t,this.h=i,this.solvedx=a,this.solvedy=c,this.spritex=s,this.spritey=o,this.visible=1,this.solved=0,this.offsetx=-1,this.offsety=-1,this.rowx=l,this.rowy=r}!function(e){function n(e){return"[object Array]"===Object.prototype.toString.call(e)}function t(e,t){if(n(e))for(var i=0;i<e.length;i++)t(e[i]);else t(e)}function i(e){var a="pending",c=[],s=[],o=[],l=null,r={done:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],i=0;i<t.length;i++)"resolved"===a&&t[i].apply(this,l),c.push(t[i]);else"resolved"===a&&arguments[e].apply(this,l),c.push(arguments[e]);return this},fail:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],i=0;i<t.length;i++)"rejected"===a&&t[i].apply(this,l),s.push(t[i]);else"rejected"===a&&arguments[e].apply(this,l),s.push(arguments[e]);return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],i=0;i<t.length;i++)"pending"===a&&o.push(t[i]);else"pending"===a&&o.push(arguments[e]);return this},then:function(){arguments.length>1&&arguments[1]&&this.fail(arguments[1]),arguments.length>0&&arguments[0]&&this.done(arguments[0]),arguments.length>2&&arguments[2]&&this.progress(arguments[2])},promise:function(e){if(null==e)return r;for(var n in r)e[n]=r[n];return e},state:function(){return a},debug:function(){console.log("[debug]",c,s,a)},isRejected:function(){return"rejected"===a},isResolved:function(){return"resolved"===a},pipe:function(e,n,a){return i(function(i){t(e,function(e){"function"==typeof e?d.done(function(){var n=e.apply(this,arguments);n&&"function"==typeof n?n.promise().then(i.resolve,i.reject,i.notify):i.resolve(n)}):d.done(i.resolve)}),t(n,function(e){"function"==typeof e?d.fail(function(){var n=e.apply(this,arguments);n&&"function"==typeof n?n.promise().then(i.resolve,i.reject,i.notify):i.reject(n)}):d.fail(i.reject)})}).promise()}},d={resolveWith:function(e){if("pending"===a){a="resolved";for(var n=l=arguments.length>1?arguments[1]:[],t=0;t<c.length;t++)c[t].apply(e,n)}return this},rejectWith:function(e){if("pending"===a){a="rejected";for(var n=l=arguments.length>1?arguments[1]:[],t=0;t<s.length;t++)s[t].apply(e,n)}return this},notifyWith:function(e){if("pending"===a)for(var n=l=arguments.length>1?arguments[1]:[],t=0;t<o.length;t++)o[t].apply(e,n);return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}},u=r.promise(d);return e&&e.apply(u,[u]),u}i.when=function(){if(arguments.length<2){var e=arguments.length?arguments[0]:void 0;return e&&"function"==typeof e.isResolved&&"function"==typeof e.isRejected?e.promise():i().resolve(e).promise()}return function(e){for(var n=i(),t=e.length,a=0,c=new Array(t),s=0;s<e.length;s++)!function(i){var s=null;e[i].done?e[i].done(function(){c[i]=arguments.length<2?arguments[0]:arguments,++a==t&&n.resolve.apply(n,c)}).fail(function(){n.reject(arguments)}):(s=e[i],e[i]=new Deferred,e[i].done(function(){c[i]=arguments.length<2?arguments[0]:arguments,++a==t&&n.resolve.apply(n,c)}).fail(function(){n.reject(arguments)}).resolve(s))}(s);return n.promise()}(arguments)},e.Deferred=i}(window);for(var loaders=[],imgpath="img/",imageloadprogress=0,imageloadtotal=0,allimages=[{name:"pictures",images:["city.jpg"],dir:""}],im=0;im<allimages.length;im++)imageloadtotal+=allimages[im].images.length,callAllPreloads(allimages[im].images,imgpath+allimages[im].dir+"/");!function(e,n){var t={canvas:0,ctx:0,canvasw:0,canvash:0,savedcanvasw:0,savedcanvash:0,idealw:1,idealh:1,canvasmode:1,piececountx:6,piececounty:3,puzzle:0,pieces:[],solvedpieces:[],clickedpiece:-1,debug:0,general:{init:function(){t.canvas=document.getElementById("canvas"),t.canvas.getContext?(t.ctx=t.canvas.getContext("2d"),t.general.initPuzzle(),this.setupEvents(),setInterval(t.general.drawPieces,10)):document.getElementById("canvas").innerHTML="Your browser does not support canvas. Sorry."},initPuzzle:function(){t.puzzle=allimages[0].images[0],t.idealw=t.puzzle.width,t.idealh=t.puzzle.height,t.general.initCanvasSize(),t.savedcanvasw=t.canvasw,t.savedcanvash=t.canvash,t.piececountx=6,t.piececounty=3,document.getElementById("piecesx").value=t.piececountx,document.getElementById("piecesy").value=t.piececounty,t.general.createPieces()},initCanvasSize:function(){var e=document.getElementById("canvasparent"),n=e.offsetWidth,i=e.offsetHeight;if(1===t.canvasmode){var a=t.general.calculateAspectRatio(t.idealw,t.idealh,n,i);t.canvas.width=t.canvasw=a[0],t.canvas.height=t.canvash=a[1]}else{t.canvas.width=n;var c=t.general.calculatePercentage(n,t.idealw);t.canvas.height=t.idealh/100*c}},calculateAspectRatio:function(e,n,t,i){var a=Math.floor(i/n*e),c=(Math.min(e,t),Math.min(n,i),Math.min(t,a)),s=c/e*n;return[c,s]},calculatePercentage:function(e,n){return 100/n*e},clearCanvas:function(){t.canvas.width=t.canvas.width},resizeCanvas:function(){t.general.initCanvasSize();for(var e=t.canvasw/t.savedcanvasw*100,n=t.canvash/t.savedcanvash*100,i=0;i<t.pieces.length;i++)t.pieces[i].x=t.pieces[i].x/100*e,t.pieces[i].y=t.pieces[i].y/100*n,t.pieces[i].w=t.pieces[i].w/100*e,t.pieces[i].h=t.pieces[i].h/100*n,t.pieces[i].solvedx=t.pieces[i].solvedx/100*e,t.pieces[i].solvedy=t.pieces[i].solvedy/100*n;for(i=0;i<t.solvedpieces.length;i++)t.solvedpieces[i].x=t.solvedpieces[i].x/100*e,t.solvedpieces[i].y=t.solvedpieces[i].y/100*n,t.solvedpieces[i].w=t.solvedpieces[i].w/100*e,t.solvedpieces[i].h=t.solvedpieces[i].h/100*n,t.solvedpieces[i].solvedx=t.solvedpieces[i].solvedx/100*e,t.solvedpieces[i].solvedy=t.solvedpieces[i].solvedy/100*n;t.savedcanvasw=t.canvasw,t.savedcanvash=t.canvash},resetPuzzle:function(){document.getElementById("options").className="optionswrapper",document.getElementById("body").className="",t.general.initPuzzle()},randomNumber:function(e,n){return Math.random()*(n-e)+e},setupEvents:function(){var e=null!==document.ontouchstart?"mousedown":"touchstart";t.canvas.addEventListener(e,function(e){var n=t.general.clickDown(e);t.general.clickPiece(n[0],n[1])},!1);var n=null!==document.ontouchstart?"mouseup":"touchend";t.canvas.addEventListener(n,function(e){t.general.releasePiece()},!1);var i=null!==document.ontouchstart?"mousemove":"touchmove";t.canvas.addEventListener(i,function(e){t.clickedpiece!==-1&&t.general.movePiece(e)},!1);var a=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("updatePuzzle").addEventListener(a,function(e){t.general.updateSettings()},!1);var c=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("showoptions").addEventListener(c,function(e){document.getElementById("options").className="optionswrapper shown"},!1);var s=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("hideoptions").addEventListener(s,function(e){document.getElementById("options").className="optionswrapper"},!1);var o=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("resetPuzzle").addEventListener(o,function(e){t.general.resetPuzzle()},!1)},clickDown:function(e){var n=t.canvas.getBoundingClientRect(),i=e.clientX-n.left,a=e.clientY-n.top;return"undefined"!=typeof e.changedTouches&&(i=e.changedTouches[0].pageX-n.left,a=e.changedTouches[0].pageY-n.top),[i,a]},clickPiece:function(e,n){for(var i=t.pieces.length-1;i>=0;i--)if(t.general.checkCollision(t.pieces[i],e,n)){t.clickedpiece=i,t.general.hideAllPieces(),t.pieces[i].visible=1,t.pieces[i].offsetx=e-t.pieces[i].x,t.pieces[i].offsety=n-t.pieces[i].y;break}},releasePiece:function(){if(t.clickedpiece!==-1){var e=t.pieces[t.clickedpiece];t.pieces.splice(t.clickedpiece,1),t.pieces.push(e);for(var n=0;n<t.pieces.length;n++)t.pieces[n].visible=1;t.pieces[t.clickedpiece].offsetx=0,t.pieces[t.clickedpiece].offsety=0,t.general.checkSolved(),t.clickedpiece=-1,0===t.pieces.length&&(document.getElementById("body").className="solved")}},movePiece:function(e){var n=t.general.clickDown(e);t.pieces[t.clickedpiece].x=n[0]-t.pieces[t.clickedpiece].offsetx,t.pieces[t.clickedpiece].y=n[1]-t.pieces[t.clickedpiece].offsety},checkSolved:function(){var e=t.pieces[t.clickedpiece].x,n=t.pieces[t.clickedpiece].y,i=t.pieces[t.clickedpiece].solvedx,a=t.pieces[t.clickedpiece].solvedy,c=30;if(Math.abs(e-i)<c&&Math.abs(n-a)<c){t.pieces[t.clickedpiece].x=i,t.pieces[t.clickedpiece].y=a,t.pieces[t.clickedpiece].solved=1;var s=t.pieces[t.clickedpiece];t.pieces.splice(t.clickedpiece,1),t.solvedpieces.push(s)}},checkCollision:function(e,n,t){return e.solved?0:t>e.y+e.h?0:t<e.y?0:n>e.x+e.w?0:n<e.x?0:1},updateSettings:function(){var e=document.getElementById("piecesx"),n=document.getElementById("piecesy"),i=Math.min(20,e.value),a=Math.min(20,n.value),c=document.getElementById("fileupload").files[0];if("undefined"!=typeof c){var s=new FileReader;s.onload=function(){var e=new Image;e.src=s.result,e.onload=function(){t.puzzle=e,t.piececountx=i,t.piececounty=a,t.idealw=t.puzzle.width,t.idealh=t.puzzle.height,t.general.initCanvasSize(),t.savedcanvasw=t.canvasw,t.savedcanvash=t.canvash,t.general.createPieces()}},s.readAsDataURL(c)}else t.piececountx=i,t.piececounty=a,t.general.createPieces();e.value=i,n.value=a,document.getElementById("body").className="",document.getElementById("options").className="optionswrapper"},hideAllPieces:function(){for(var e=0;e<t.pieces.length;e++)t.pieces[e].visible=0},createPieces:function(){t.pieces=[],t.solvedpieces=[];for(var e=t.canvasw/t.piececountx,n=t.canvash/t.piececounty,i=t.canvasw/100*10,a=(t.canvasw-e)/100*90,c=t.canvash/100*10,s=(t.canvash-n)/100*90,o=0;o<t.piececounty;o++)for(var l=0;l<t.piececountx;l++){var r=t.general.randomNumber(i,a),d=t.general.randomNumber(c,s);t.debug&&(r=e*l,d=n*o);var u=e*l,p=n*o,v=0,h=0,f=new NewPiece(r,d,e,n,u,p,v,h,l,o);t.pieces.push(f)}},isEven:function(e){return e%2==0},drawPieces:function(){t.general.clearCanvas();for(var e=t.solvedpieces.length,n=0;n<e;n++)t.general.drawPiece(t.solvedpieces[n]);e=t.pieces.length;for(var i=0;i<e;i++)t.general.drawPiece(t.pieces[i])},drawTabOrBlank:function(e,n,i){var a=Math.min(e.h/4,e.w/4),c=0,s=0,o=0,l=0;switch(n){case 0:c=e.x+e.w/2,s=e.y,o=1*Math.PI,l=0*Math.PI;break;case 1:c=e.x+e.w,s=e.y+e.h/2,o=1.5*Math.PI,l=.5*Math.PI;break;case 2:c=e.x+e.w/2,s=e.y+e.h,o=0*Math.PI,l=1*Math.PI;break;case 3:c=e.x,s=e.y+e.h/2,o=.5*Math.PI,l=1.5*Math.PI}t.ctx.arc(c,s,a,o,l,i)},drawPiece:function(e){var n=(t.general.isEven(t.piececountx),t.general.isEven(t.piececounty),t.general.isEven(e.rowx)),i=t.general.isEven(e.rowy);t.ctx.save(),e.solved?(t.ctx.lineWidth=0,t.ctx.strokeStyle="rgba(0,0,0,0)"):(t.ctx.lineWidth=2,t.ctx.strokeStyle="rgba(0,0,0,0.5)"),e.visible||(t.ctx.globalAlpha=.3),t.ctx.beginPath(),t.ctx.moveTo(e.x,e.y),e.rowy>0&&(i?n?t.general.drawTabOrBlank(e,0,1):t.general.drawTabOrBlank(e,0,0):n?t.general.drawTabOrBlank(e,0,0):t.general.drawTabOrBlank(e,0,1)),t.ctx.lineTo(e.x+e.w,e.y),e.rowx<t.piececountx-1&&(i?n?t.general.drawTabOrBlank(e,1,0):t.general.drawTabOrBlank(e,1,1):n?t.general.drawTabOrBlank(e,1,1):t.general.drawTabOrBlank(e,1,0)),t.ctx.lineTo(e.x+e.w,e.y+e.h),e.rowy<t.piececounty-1&&(i?n?t.general.drawTabOrBlank(e,2,1):t.general.drawTabOrBlank(e,2,0):n?t.general.drawTabOrBlank(e,2,0):t.general.drawTabOrBlank(e,2,1)),t.ctx.lineTo(e.x,e.y+e.h),e.rowx>0&&(i?n?t.general.drawTabOrBlank(e,3,0):t.general.drawTabOrBlank(e,3,1):n?t.general.drawTabOrBlank(e,3,1):t.general.drawTabOrBlank(e,3,0)),t.ctx.lineTo(e.x,e.y),t.ctx.closePath(),t.ctx.clip(),t.ctx.drawImage(t.puzzle,0-e.solvedx+e.x,0-e.solvedy+e.y,t.canvasw,t.canvash),t.ctx.stroke(),t.ctx.restore()}}};e.js=t}(window),window.onload=function(){Deferred.when(loaders).then(function(){js.general.init()});var e;window.addEventListener("resize",function(n){clearTimeout(e),e=setTimeout(js.general.resizeCanvas,200)})};